---
title: "Report on the use of prescribed fire on bird communities in Canada's National Parks"
format:
  html:
    grid:
      margin-width: 300px
navbar: right
theme: cosmo
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: 
  - name: "Alex MacPhail"
    affiliation: "Biodiversity Pathways Ltd."
  - name: "Gregg Walker"
    affiliation: "Parks Canada"
editor: visual
nocite: '@*'
bibliography: references.bib
toc: true
toc-depth: 3
toc-expand: true
prefer-html: true
toc-location: left
styles: styles.css
github: https://github.com/biodiversitypathways/pc-prescribed-fire
---

This is a test

```{r}

library(wildrtrax)
library(tidyverse)
library(sf)
library(leaflet)
library(vegan)

load("pc-fire.RData")
#save.image("pc-fire.RData")

wt_auth()
```

```{r, eval = F, include = T}
# Download data

burn_projects <- c(2291, 282, 662, 672, 1092, 2021, 2878, 3577, 388, 1251, 1252, 1253, 1935, 2879, 2195, 2317, 2286, 2300, 2640, 2282, 3127)

pf_fire_locs <- read_csv("pf-fire-locations.csv") |>
  mutate(year = year(parse_date_time(recording_date_time, orders = c("mdy HM")))) |>
  select(-recording_date_time) |>
  distinct() |>
  filter(!location_id == 489836)

burns <- wt_get_projects("ARU") |>
  filter(project_id %in% burn_projects) |>
  pull(project_id) |>
  wt_download_report('ARU', 'main') |>
  bind_rows() |>
  mutate(year = year(recording_date_time))


```

# Introduction


# Methods

```{r}
# Wrangle

burn_locs <- burns |>
  select(location, location_id, latitude, longitude) |>
  distinct() |>
  filter(!is.na(latitude))

burn_locs |>
  filter(is.na(latitude)) |>
  left_join(burns |> select(project_id, location_id) |> distinct(), by = "location_id") |>
  left_join(wt_get_projects("ARU") |> select(project_id, organization_name) |> distinct(), by = "project_id") |>
  select(organization_name, location) |>
  distinct() |>
  view()

burns_fire <- burns |>
  left_join(pf_fire_locs, by = c("location_id","year"))

```

```{r}
# Map

leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    data = burn_locs,
    popup = ~paste("Location:", location, "<br>"),
    fillOpacity = 1,
    color = "black", 
    radius = 6 
  ) %>%
  addMeasure(primaryLengthUnit = "meters", primaryAreaUnit = "sqmeters") %>%
  addMiniMap(position = "bottomleft")

```

```{r}
# Covariates

covs <- burns_fire |>
  left_join(wt_get_projects("ARU") |> select(organization_name, project, project_id), by = "project_id") |>
  select(organization_name, project, project_id, location, location_id, year, sample_type, freq_burned, yrs_since_fire, pf_severity, veg_type) |>
  distinct()

covs |>
  count(organization_name, project, project_id, year)
covs |>
  count(veg_type)
covs |>
  count(location, year) |> 
  filter(n>1)

```

# Results

```{r}

shannon_d <- burns_fire |> 
  wt_tidy_species(remove = c("mammal","amphibian","abiotic","insect","unknown"), zerofill = F) |>
  inner_join(wt_get_species() |> dplyr::select(species_code, species_class, species_order), by = "species_code") |>
  dplyr::select(location, location_id, recording_date_time, species_code, species_common_name, individual_order, abundance) |>
  distinct() |>
  group_by(location, location_id, recording_date_time, species_code, species_common_name) |>
  summarise(count = max(individual_order)) |>
  ungroup() |>
  pivot_wider(names_from = species_code, values_from = count, values_fill = 0) |>
  pivot_longer(cols = -(location:species_common_name), names_to = "species", values_to = "count") |>
  group_by(location, location_id, year = year(recording_date_time), species) |>
  summarise(total_count = sum(count)) |>
  ungroup() |>
  group_by(location, location_id, year) |>
  summarise(shannon_index = diversity(total_count, index = "shannon")) |>
  ungroup() |>
  left_join(covs |> select(location_id:veg_type), by = c("location_id","year"))
  

shannon_d |>
  filter(!is.na(shannon_index), !is.na(veg_type)) |>
  ggplot(aes(x = factor(year), y = shannon_index, fill = factor(year))) +
  geom_boxplot() +
  geom_point(alpha = 0.6, colour = "grey") +
  labs(x = "Year",
       y = "Shannon diversity index per location") +
  theme_bw() +
  guides(fill = guide_legend(title = "Year")) +
  scale_fill_viridis_d(alpha = 0.8, option = "cividis") +
  facet_wrap(~ veg_type)

```
```{r}

shannon_d |>
  filter(!is.na(shannon_index), !is.na(sample_type), !is.na(veg_type)) |>
  mutate(sample_type = factor(sample_type, levels = c("pre-burn", "post-burn"))) |>
  ggplot(aes(x = sample_type, y = shannon_index, fill = sample_type)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  geom_jitter(width = 0.2, alpha = 0.6, color = "grey40") +
  facet_wrap(~ veg_type, scales = "free_y") +
  scale_fill_viridis_d(option = "cividis", end = 0.8) +
  labs(
    x = "Burn Status",
    y = "Shannon Diversity Index",
    fill = "Sample Type",
    title = "Shannon Diversity Pre- and Post-Burn by Vegetation Type"
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "bottom"
  )

```

# Discussion and Recommendations
